---
import { existsSync } from 'node:fs';
import { join } from 'node:path';

interface Props {
  alt: string;
  aspect?: 'hero' | 'square' | 'wide' | 'tall';
  icon?: 'filter' | 'water' | 'camping' | 'hiking' | 'gravity' | 'pump' | 'bottle' | 'straw' | 'uv' | 'rv' | 'backpack' | 'compare' | 'tools' | 'shield' | 'gear' | 'faucet' | 'pitcher' | 'fridge' | 'house' | 'tablet';
  caption?: string;
  class?: string;
  priority?: boolean;
  src?: string;
  slug?: string;
}

const {
  alt,
  aspect = 'wide',
  icon = 'filter',
  caption,
  class: className = '',
  priority = false,
  src: srcProp,
  slug,
} = Astro.props;

// Resolve image source: explicit src > auto-detect from slug > fallback to placeholder
let imageSrc = srcProp;
if (!imageSrc && slug) {
  const candidate = `/assets/${slug}-hero.webp`;
  if (existsSync(join(process.cwd(), 'public', candidate))) {
    imageSrc = candidate;
  }
}

const hasImage = !!imageSrc;

// For real product images (which are square from Amazon), use a 4:5 portrait
// container instead of wide/hero ratios — it better frames the product.
// Placeholders keep their original requested aspect.
const showcaseAspect = hasImage && (aspect === 'hero' || aspect === 'wide')
  ? 'aspect-[4/5]'
  : hasImage && aspect === 'square'
    ? 'aspect-square'
    : hasImage && aspect === 'tall'
      ? 'aspect-[2/3]'
      : null;

const aspectMap = {
  hero: 'aspect-[16/9]',
  square: 'aspect-square',
  wide: 'aspect-[3/2]',
  tall: 'aspect-[2/3]',
};

const icons: Record<string, string> = {
  filter: `<path d="M28 28h40l-14 20v16l-12 0V48z" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><path d="M24 24h48" stroke="currentColor" stroke-width="3" opacity="0.5"/><circle cx="48" cy="20" r="2" fill="currentColor" opacity="0.3"/>`,
  water: `<path d="M48 24c-8 12-18 20-18 32a18 18 0 0036 0c0-12-10-20-18-32z" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><path d="M40 58c-2-2-3-5-3-8 0-6 5-10 11-16" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25"/>`,
  camping: `<path d="M20 68h56M28 68L48 34l20 34M48 34v-8M44 46l-8 22M52 46l8 22" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><circle cx="64" cy="30" r="4" fill="currentColor" opacity="0.2"/>`,
  hiking: `<circle cx="48" cy="24" r="5" stroke="currentColor" stroke-width="2" fill="none" opacity="0.4"/><path d="M48 30v14l-8 16M48 44l8 16M38 38h20M42 30l-6-4M54 30l6-4" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/>`,
  gravity: `<rect x="36" y="20" width="24" height="28" rx="3" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><rect x="36" y="50" width="24" height="22" rx="3" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.35"/><path d="M48 48v4" stroke="currentColor" stroke-width="3" opacity="0.4"/><path d="M42 30h12M42 36h12" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>`,
  pump: `<circle cx="48" cy="42" r="14" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M48 28v-6M42 22h12" stroke="currentColor" stroke-width="3" opacity="0.4"/><path d="M48 56v10M44 66h8" stroke="currentColor" stroke-width="2" opacity="0.3"/><path d="M40 42a8 8 0 0116 0" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>`,
  bottle: `<path d="M42 24h12v6c6 2 8 6 8 12v22a4 4 0 01-4 4H38a4 4 0 01-4-4V42c0-6 2-10 8-12z" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M38 48h20" stroke="currentColor" stroke-width="1.5" opacity="0.25"/><path d="M38 56h20" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>`,
  straw: `<path d="M48 20v52" stroke="currentColor" stroke-width="4" opacity="0.35"/><path d="M44 28h8" stroke="currentColor" stroke-width="2" opacity="0.3"/><path d="M44 36h8" stroke="currentColor" stroke-width="2" opacity="0.3"/><circle cx="48" cy="22" r="4" stroke="currentColor" stroke-width="2" fill="none" opacity="0.4"/><path d="M42 68c0 4 12 4 12 0" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>`,
  uv: `<circle cx="48" cy="48" r="16" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.35"/><path d="M48 28v-4M48 72v-4M28 48h-4M72 48h-4M34 34l-3-3M65 65l-3-3M62 34l3-3M31 65l3-3" stroke="currentColor" stroke-width="2.5" opacity="0.3"/><circle cx="48" cy="48" r="6" fill="currentColor" opacity="0.2"/>`,
  rv: `<rect x="22" y="36" width="52" height="26" rx="4" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M22 42h52" stroke="currentColor" stroke-width="1.5" opacity="0.25"/><circle cx="34" cy="62" r="5" stroke="currentColor" stroke-width="2" fill="none" opacity="0.35"/><circle cx="62" cy="62" r="5" stroke="currentColor" stroke-width="2" fill="none" opacity="0.35"/><path d="M22 36l6-10h20l6 10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>`,
  backpack: `<path d="M36 30c0-6 5-10 12-10s12 4 12 10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/><rect x="32" y="30" width="32" height="38" rx="4" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M40 30v38M56 30v38" stroke="currentColor" stroke-width="1.5" opacity="0.2"/><rect x="40" y="38" width="16" height="10" rx="2" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>`,
  compare: `<rect x="24" y="30" width="18" height="36" rx="3" stroke="currentColor" stroke-width="2" fill="none" opacity="0.35"/><rect x="54" y="30" width="18" height="36" rx="3" stroke="currentColor" stroke-width="2" fill="none" opacity="0.35"/><path d="M44 42h8M44 48h8M44 54h8" stroke="currentColor" stroke-width="2" opacity="0.3"/>`,
  tools: `<path d="M36 60l-8 8M60 60l8 8M36 60c0-8 6-16 12-20M60 60c0-8-6-16-12-20" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><circle cx="48" cy="36" r="4" fill="currentColor" opacity="0.3"/>`,
  shield: `<path d="M48 24l-18 8v14c0 12 8 20 18 26 10-6 18-14 18-26V32z" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><polyline points="40 48 46 54 58 42" stroke="currentColor" stroke-width="3" fill="none" opacity="0.5"/>`,
  gear: `<circle cx="48" cy="48" r="8" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><path d="M48 28v6M48 62v6M28 48h6M62 48h6M34 34l4 4M58 58l4 4M34 62l4-4M58 34l4-4" stroke="currentColor" stroke-width="3" opacity="0.35"/>`,
  faucet: `<path d="M30 40h20c8 0 12 4 12 10v14" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><path d="M62 58v8" stroke="currentColor" stroke-width="2" opacity="0.3"/><path d="M26 36v8M30 32h-8" stroke="currentColor" stroke-width="2.5" opacity="0.35"/><path d="M56 66h12" stroke="currentColor" stroke-width="2" opacity="0.25"/>`,
  pitcher: `<path d="M34 28h24l-2 36a4 4 0 01-4 4H40a4 4 0 01-4-4z" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M58 36c4 0 8 4 8 8s-4 8-8 8" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/><path d="M38 28v-4h16v4" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/><path d="M38 44h16" stroke="currentColor" stroke-width="1.5" opacity="0.2"/>`,
  fridge: `<rect x="32" y="20" width="32" height="56" rx="3" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.4"/><path d="M32 44h32" stroke="currentColor" stroke-width="2" opacity="0.35"/><path d="M56 30v10M56 50v10" stroke="currentColor" stroke-width="2" opacity="0.3"/>`,
  house: `<path d="M24 44l24-18 24 18" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/><rect x="30" y="44" width="36" height="26" rx="2" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.35"/><rect x="42" y="54" width="12" height="16" rx="1" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>`,
  tablet: `<circle cx="48" cy="48" r="18" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.35"/><circle cx="48" cy="48" r="6" stroke="currentColor" stroke-width="2" fill="none" opacity="0.4"/><path d="M48 30v12M48 54v12M30 48h12M54 48h12" stroke="currentColor" stroke-width="1.5" opacity="0.2"/>`,
};

const iconSvg = icons[icon] || icons.filter;
---

{hasImage ? (
  <figure class:list={['product-image-real', className]}>
    <div class:list={['image-showcase', showcaseAspect || aspectMap[aspect]]}>
      <div class="showcase-inner">
        <!-- Subtle dark-to-lighter radial gradient backdrop -->
        <div class="showcase-backdrop"></div>
        <!-- Ambient brand-colored glow behind the product -->
        <div class="showcase-glow"></div>
        <img
          src={imageSrc}
          srcset={imageSrc?.endsWith('.webp') ? `${imageSrc.replace('.webp', '-small.webp')} 400w, ${imageSrc.replace('.webp', '-medium.webp')} 800w, ${imageSrc} 1200w` : undefined}
          sizes={imageSrc?.endsWith('.webp') ? '(max-width: 640px) 400px, (max-width: 1024px) 800px, 1200px' : undefined}
          alt={alt}
          loading={priority ? 'eager' : 'lazy'}
          decoding={priority ? 'sync' : 'async'}
          fetchpriority={priority ? 'high' : undefined}
          class="showcase-image"
        />
      </div>
    </div>
    {caption && <figcaption class="image-caption">{caption}</figcaption>}
  </figure>
) : (
  <figure class:list={['product-image-placeholder', className]}>
    <div class:list={['image-container', aspectMap[aspect]]}>
      <div class="image-inner">
        <div class="image-gradient"></div>
        <div class="image-pattern"></div>
        <svg viewBox="0 0 96 96" class="image-icon" aria-hidden="true">
          <Fragment set:html={iconSvg} />
        </svg>
        <div class="image-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          <span>{alt}</span>
        </div>
      </div>
    </div>
    {caption && <figcaption class="image-caption">{caption}</figcaption>}
  </figure>
)}

<style>
  /* ── Spotlight Vignette Showcase ── */
  .product-image-real {
    margin: 2rem 0;
    border-radius: 1rem;
    overflow: hidden;
  }

  .image-showcase {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 1rem;
  }

  .showcase-inner {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Dark base with a subtle lighter center — the "stage" */
  .showcase-backdrop {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(
        ellipse 65% 65% at 50% 48%,
        hsl(210 15% 18%) 0%,
        hsl(210 18% 12%) 35%,
        hsl(var(--card)) 65%,
        hsl(var(--background)) 100%
      );
  }

  /* Brand-colored ambient glow */
  .showcase-glow {
    position: absolute;
    inset: 15%;
    border-radius: 50%;
    background:
      radial-gradient(
        circle at 45% 45%,
        hsl(var(--primary) / 0.10) 0%,
        hsl(var(--primary) / 0.04) 40%,
        transparent 70%
      );
    filter: blur(20px);
    z-index: 0;
  }

  /* The product image with radial mask vignette */
  .showcase-image {
    position: relative;
    max-width: 88%;
    max-height: 88%;
    width: auto;
    height: auto;
    object-fit: contain;
    z-index: 1;
    /* Radial mask: fully visible center, smooth fade at edges eliminates white bg */
    mask-image: radial-gradient(
      ellipse 80% 80% at 50% 50%,
      black 45%,
      rgba(0, 0, 0, 0.6) 60%,
      rgba(0, 0, 0, 0.2) 72%,
      transparent 82%
    );
    -webkit-mask-image: radial-gradient(
      ellipse 80% 80% at 50% 50%,
      black 45%,
      rgba(0, 0, 0, 0.6) 60%,
      rgba(0, 0, 0, 0.2) 72%,
      transparent 82%
    );
    filter: drop-shadow(0 4px 24px rgba(0, 0, 0, 0.25));
    transition: transform 0.4s ease, filter 0.4s ease;
  }

  .image-showcase:hover .showcase-image {
    transform: scale(1.03);
    filter: drop-shadow(0 8px 32px rgba(0, 0, 0, 0.35));
  }

  .image-showcase:hover .showcase-glow {
    background:
      radial-gradient(
        circle at 45% 45%,
        hsl(var(--primary) / 0.16) 0%,
        hsl(var(--primary) / 0.06) 40%,
        transparent 70%
      );
    transition: background 0.4s ease;
  }

  .product-image-placeholder {
    margin: 2rem 0;
    border-radius: 1rem;
    overflow: hidden;
  }

  .image-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 1rem;
    border: 1px solid hsl(var(--border));
  }

  .image-inner {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .image-gradient {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 30% 40%, hsl(var(--primary) / 0.06), transparent),
      radial-gradient(ellipse 50% 40% at 70% 60%, hsl(var(--accent) / 0.04), transparent),
      linear-gradient(135deg, hsl(var(--card)), hsl(var(--muted)));
  }

  .image-pattern {
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(circle at 1px 1px, hsl(var(--border) / 0.3) 1px, transparent 0);
    background-size: 24px 24px;
    mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 20%, transparent 70%);
    -webkit-mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 20%, transparent 70%);
  }

  .image-icon {
    position: relative;
    width: 96px;
    height: 96px;
    color: hsl(var(--primary));
    animation: float-gentle 6s ease-in-out infinite;
    filter: drop-shadow(0 0 20px hsl(var(--primary) / 0.15));
  }

  @keyframes float-gentle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .image-label {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: hsl(var(--background) / 0.7);
    backdrop-filter: blur(8px);
    border: 1px solid hsl(var(--border) / 0.5);
    border-radius: 9999px;
    font-size: 0.75rem;
    color: hsl(var(--muted-foreground));
    max-width: 80%;
    text-align: center;
  }

  .image-label span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .image-caption {
    padding: 0.75rem 0 0;
    font-size: 0.8125rem;
    color: hsl(var(--muted-foreground));
    text-align: center;
    font-style: italic;
  }

  /* Shimmer on showcase (real images) */
  .image-showcase::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      105deg,
      transparent 40%,
      hsl(var(--primary) / 0.04) 46%,
      hsl(var(--primary) / 0.08) 50%,
      hsl(var(--primary) / 0.04) 54%,
      transparent 60%
    );
    background-size: 200% 100%;
    animation: shimmer-slow 8s ease-in-out infinite;
    pointer-events: none;
    z-index: 2;
    border-radius: 1rem;
    mask-image: radial-gradient(ellipse 60% 60% at 50% 50%, transparent 30%, black 70%);
    -webkit-mask-image: radial-gradient(ellipse 60% 60% at 50% 50%, transparent 30%, black 70%);
  }

  .image-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      105deg,
      transparent 40%,
      hsl(var(--primary) / 0.03) 45%,
      hsl(var(--primary) / 0.06) 50%,
      hsl(var(--primary) / 0.03) 55%,
      transparent 60%
    );
    background-size: 200% 100%;
    animation: shimmer-slow 8s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes shimmer-slow {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
  }
</style>
