---
import { AFFILIATE_TAG, getPriceTier } from '../lib/config';

interface Product {
  name: string;
  asin: string;
  tag?: string;
  rating: string;
  price: string;
  filtrationStages?: string;
  filtrationTechnology?: string;
  micronRating?: string;
  capacity?: string;
  flowRate?: string;
  certifications?: string;
  filterLife?: string;
  contaminantsRemoved?: string;
  packSize?: string;
  compatibility?: string;
  highlight?: string;
  isEditorsPick?: boolean;
}

interface Props {
  products: Product[];
  features?: Array<{
    label: string;
    key: keyof Product;
  }>;
}

const { products, features } = Astro.props;

const defaultFeatures = [
  { label: 'Price Range', key: 'price' as keyof Product },
  { label: 'Rating', key: 'rating' as keyof Product },
  { label: 'Filtration', key: 'filtrationTechnology' as keyof Product },
  { label: 'Stages', key: 'filtrationStages' as keyof Product },
  { label: 'Micron Rating', key: 'micronRating' as keyof Product },
  { label: 'Capacity', key: 'capacity' as keyof Product },
  { label: 'Certifications', key: 'certifications' as keyof Product },
  { label: 'Filter Life', key: 'filterLife' as keyof Product },
];

const displayFeatures = features || defaultFeatures;
---

<div class="comparison-table-wrapper">
  <div class="comparison-table-scroll">
    <table class="comparison-table">
      <thead>
        <tr>
          <th class="feature-col">Feature</th>
          {products.map((product) => (
            <th class:list={['product-col', { 'editors-pick': product.isEditorsPick }]}>
              <div class="product-header">
                {product.isEditorsPick && <span class="pick-badge">Editor's Pick</span>}
                <span class="product-name">{product.name}</span>
              </div>
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {displayFeatures.map((feature) => (
          <tr>
            <td class="feature-label">{feature.label}</td>
            {products.map((product) => {
              const value = product[feature.key];
              return (
                <td class:list={[{ 'editors-pick': product.isEditorsPick }]}>
                  {feature.key === 'price' ? getPriceTier(String(value)) : String(value || '—')}
                </td>
              );
            })}
          </tr>
        ))}
        {products.some(p => p.contaminantsRemoved) && (
          <tr>
            <td class="feature-label">Key Contaminants</td>
            {products.map((product) => (
              <td class:list={[{ 'editors-pick': product.isEditorsPick }]}>
                <span class="contaminants-text">{product.contaminantsRemoved || '—'}</span>
              </td>
            ))}
          </tr>
        )}
        <tr class="cta-row">
          <td class="feature-label"></td>
          {products.map((product) => (
            <td class:list={[{ 'editors-pick': product.isEditorsPick }]}>
              <a
                href={`https://www.amazon.com/dp/${product.asin}?tag=${product.tag || AFFILIATE_TAG}`}
                target="_blank"
                rel="nofollow sponsored noopener"
                class:list={['table-cta', { 'table-cta-primary': product.isEditorsPick }]}
              >
                Check Price
              </a>
            </td>
          ))}
        </tr>
      </tbody>
    </table>
  </div>
</div>

<style>
  .comparison-table-wrapper {
    margin: 2rem 0;
    border: 1px solid hsl(var(--border));
    border-radius: 1rem;
    overflow: hidden;
    background: hsl(var(--card));
  }

  .comparison-table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
    min-width: 600px;
    table-layout: fixed;
  }

  .comparison-table thead {
    background: hsl(var(--muted));
    border-bottom: 1px solid hsl(var(--border));
  }

  .comparison-table th {
    padding: 1.25rem 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 0.875rem;
    letter-spacing: -0.01em;
    color: hsl(var(--foreground));
  }

  .feature-col {
    text-align: left !important;
    width: 140px;
    min-width: 140px;
  }

  .product-col {
    min-width: 160px;
  }

  .product-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.375rem;
  }

  .pick-badge {
    display: inline-block;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.2rem 0.625rem;
    border-radius: 9999px;
    background: hsl(var(--primary) / 0.12);
    color: hsl(var(--primary));
    border: 1px solid hsl(var(--primary) / 0.2);
  }

  .product-name {
    font-weight: 700;
  }

  .comparison-table td {
    padding: 1rem;
    text-align: center;
    border-bottom: 1px solid hsl(var(--border) / 0.5);
    color: hsl(var(--muted-foreground));
    vertical-align: top;
    font-size: 0.875rem;
  }

  .feature-label {
    text-align: left !important;
    font-weight: 600;
    color: hsl(var(--foreground));
    font-size: 0.875rem;
  }

  .editors-pick {
    background: hsl(var(--primary) / 0.03);
    border-left: 1px solid hsl(var(--primary) / 0.1);
    border-right: 1px solid hsl(var(--primary) / 0.1);
  }

  thead .editors-pick {
    border-top: 2px solid hsl(var(--primary) / 0.4);
  }

  .contaminants-text {
    font-size: 0.8125rem;
    line-height: 1.5;
  }

  .cta-row td {
    padding: 1.25rem 1rem;
    border-bottom: none;
  }

  .table-cta {
    display: inline-block;
    padding: 0.625rem 1.25rem;
    border-radius: 0.625rem;
    font-weight: 700;
    font-size: 0.875rem;
    border: 1px solid hsl(var(--border));
    color: hsl(var(--foreground));
    background: hsl(var(--muted));
    transition: all 0.2s;
    text-decoration: none;
  }

  .table-cta:hover {
    border-color: hsl(var(--primary));
    color: #fff;
    background: hsl(var(--primary) / 0.15);
  }

  .table-cta-primary {
    background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-warm)));
    color: #fff !important;
    border-color: transparent;
    box-shadow: 0 4px 12px -2px hsl(var(--primary) / 0.3);
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .table-cta-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px -2px hsl(var(--primary) / 0.4);
    color: #fff !important;
    background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-warm)));
    filter: brightness(1.1);
  }
</style>
