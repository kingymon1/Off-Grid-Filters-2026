# Plan: Automated Content Generation & Scheduled Publishing Pipeline

## Problem

The site currently has 80 handcrafted `.astro` pages with inline editorial content. Adding a new comparison or guide requires manually:

1. Adding entries to `src/lib/config.ts` (comparison/guide metadata)
2. Creating an individual `.astro` page file with full narrative content (~200-400 lines)
3. Updating `src/lib/image-map.ts` (hero image entry)
4. Committing, pushing, rebuilding, and deploying

The goal: automate this so new content is generated by AI and pushed live at configurable intervals.

## Architecture

```
content-queue.yaml              ← Define what to generate (comparisons, guides, etc.)
        ↓
scripts/generate-content.mjs    ← Node script: reads queue, calls Claude API, writes files
        ↓
Outputs: new .astro files + config.ts patches + image-map.ts patches
        ↓
.github/workflows/content-pipeline.yml   ← Scheduled GitHub Action (weekly/bi-weekly)
        ↓
Opens PR for review  OR  auto-merges (hands-off mode)
        ↓
Vercel auto-deploys on merge to main
```

## Implementation Details

### 1. Content Queue (`content-queue.yaml`)

A YAML file defining upcoming content. Each entry specifies content type, parameters, and target publish date. The generation script processes `status: pending` entries and marks them `status: generated`.

```yaml
queue:
  - type: comparison
    status: pending
    target_date: "2026-03-01"
    productA: "ispring-rcc7ak"
    productB: "bluevua-ro100ropot-uv"
    slug: "ispring-rcc7ak-vs-bluevua-ro100ropot-uv"

  - type: activity-guide
    status: pending
    target_date: "2026-03-08"
    slug: "water-filters-for-van-life"
    title: "Best Water Filters for Van Life: 2026 Guide"
    description: "How to choose and use water filters for van life and mobile living."

  - type: knowledge
    status: pending
    target_date: "2026-03-15"
    slug: "activated-carbon-explained"
    title: "Activated Carbon Filters Explained"
    description: "How activated carbon filtration works and when to use it."
```

### 2. Content Generation Script (`scripts/generate-content.mjs`)

The core script (~400 lines). For each pending queue entry it:

1. **Reads an existing page of the same type** as a structural template (e.g., reads `amazon-basics-vs-brita-standard.astro` when generating a new comparison). This keeps the AI output structurally consistent with the rest of the site without maintaining separate template files.
2. **Reads product data from `config.ts`** — for comparisons, it loads both products' specs, pros/cons, ratings, and pricing.
3. **Calls the Claude API** with a prompt containing:
   - The template page structure
   - Product data (for product-referencing content)
   - Writing guidelines from CLAUDE.md (BLUF style, honest pros/cons, authority tone)
   - Instructions to produce a complete `.astro` file matching the template's imports, components, and schema setup
4. **Writes the `.astro` file** to the correct directory
5. **Patches `config.ts`** — appends new comparison/guide entries to the relevant arrays
6. **Patches `image-map.ts`** — adds hero image entries for new pages
7. **Runs `scripts/generate-local-images.mjs`** — creates SVG placeholder images for new pages
8. **Marks the queue entry** as `status: generated`

Requires `ANTHROPIC_API_KEY` in `.env`.

### 3. Config Patcher Utility (`scripts/lib/config-patcher.mjs`)

A module that programmatically edits `config.ts` and `image-map.ts`:

- **Comparisons:** Appends a `Comparison` object to the `comparisons` array
- **Guides:** Appends a `GuideConfig` object to the `guides` array
- **Image map:** Adds slug → path entries in `heroImages`
- Uses regex-based insertion (find the array's closing `]`, insert before it)
- Preserves formatting

### 4. GitHub Actions Workflow (`.github/workflows/content-pipeline.yml`)

```yaml
name: Content Generation Pipeline

on:
  schedule:
    - cron: '0 4 * * 1'    # Every Monday at 4 AM UTC
  workflow_dispatch:         # Manual trigger

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci

      - name: Generate pending content
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-content.mjs

      - name: Validate
        run: |
          npm run build
          npm run checklist:auto

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: content/auto-${{ github.run_number }}
          title: "content: new pages for week of $(date +%Y-%m-%d)"
          body: |
            Auto-generated content from the content pipeline.
            Review for quality before merging.
          commit-message: "content: add auto-generated pages"
```

### 5. Image Handling

New pages need hero images. The script runs `generate-local-images.mjs` to create branded SVG placeholders immediately. If `GEMINI_API_KEY` is also available, it generates AI editorial photos too. Placeholders are replaced transparently — no code changes needed.

### 6. New Files

| File | Purpose | ~Lines |
|------|---------|--------|
| `content-queue.yaml` | Defines what content to generate | ~50 |
| `scripts/generate-content.mjs` | Main generation orchestrator | ~400 |
| `scripts/lib/config-patcher.mjs` | Programmatic config/image-map editor | ~200 |
| `scripts/lib/template-reader.mjs` | Reads existing pages as AI templates | ~100 |
| `.github/workflows/content-pipeline.yml` | Scheduled GitHub Action | ~50 |

### 7. Modified Files

| File | Change |
|------|--------|
| `package.json` | Add `@anthropic-ai/sdk` dep + `"generate-content"` script |
| `.env.example` | Add `ANTHROPIC_API_KEY=` entry |

## Content Type Feasibility

| Type | Feasibility | Why |
|------|------------|-----|
| **Comparisons** | High | Both products already in config with full specs — AI compares them |
| **Activity guides** | High | Templated structure, recommendations from existing catalog |
| **Knowledge base** | High | Educational explainers — AI excels at these |
| **Buyer guides** | Medium | Deeper niche expertise needed, benefits from review |
| **Product reviews** | Low | Requires real product research — do manually |
| **Category roundups** | Low | Only needed when new categories are added |

## Scheduling Options

| Cadence | Cron | Volume |
|---------|------|--------|
| Weekly | `0 4 * * 1` | ~1 piece/week |
| Bi-weekly | `0 4 1,15 * *` | ~2 pieces/month |
| Batch monthly | `0 4 1 * *` | Generate 4 pieces at once with staggered `target_date` |

The `target_date` controls when content goes live (via existing `isPublished()` gate). The cron controls when generation runs. You can batch-generate a month of content in one run, each with different `target_date` values.

## Quality Safeguards

1. **PR review gate** — Generated content opens a PR, doesn't go directly to main
2. **Build validation** — `npm run build` must pass in the pipeline
3. **Automated checklist** — `npm run checklist:auto` catches SEO/schema/link issues
4. **Template-based generation** — AI follows exact structure of existing pages
5. **Dry run mode** — `node scripts/generate-content.mjs --dry-run` previews without writing
6. **Manual override** — Edit any generated file before approving the PR
